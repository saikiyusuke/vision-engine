name: Airãƒ¬ã‚¸è‡ªå‹•åŒæœŸï¼ˆAutoClaude Visionï¼‰

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
  
  # å®šæœŸå®Ÿè¡Œï¼ˆæ—¥æœ¬æ™‚é–“10:00-23:00ã®æ¯æ™‚0åˆ†ï¼‰
  schedule:
    # UTCæ™‚é–“ã§è¨­å®šï¼ˆæ—¥æœ¬æ™‚é–“-9æ™‚é–“ï¼‰
    # æ—¥æœ¬æ™‚é–“10æ™‚ = UTC 1æ™‚
    # æ—¥æœ¬æ™‚é–“23æ™‚ = UTC 14æ™‚
    - cron: '0 1-14 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆå¿µã®ãŸã‚30åˆ†ï¼‰
    timeout-minutes: 30

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: ğŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd vision-engine
          npm ci

      # Playwrightã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ğŸŒ Playwright ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd vision-engine
          npx playwright install chromium
          npx playwright install-deps chromium

      # PHPã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ç”¨ï¼‰
      - name: ğŸ˜ PHP ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, curl

      # Airãƒ¬ã‚¸è‡ªå‹•åŒæœŸã‚’å®Ÿè¡Œ
      - name: ğŸš€ Airãƒ¬ã‚¸è‡ªå‹•åŒæœŸã‚’å®Ÿè¡Œ
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AIRREGI_USERNAME: ${{ secrets.AIRREGI_USERNAME }}
          AIRREGI_PASSWORD: ${{ secrets.AIRREGI_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          CI: true
        run: |
          cd vision-engine
          node airregi-autoclaude-scheduled.js

      # ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ
      - name: ğŸ“¸ ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: |
            vision-engine/*.png
            vision-engine/downloads/*.csv
          retention-days: 7

      # æˆåŠŸæ™‚ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆï¼ˆCSVãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
      - name: ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸCSVã‚’ä¿å­˜
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: airregi-csv-${{ github.run_id }}
          path: vision-engine/downloads/*.csv
          retention-days: 30

      # å®Ÿè¡Œçµæœã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: ğŸ“§ å®Ÿè¡Œçµæœã‚’é€šçŸ¥
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Airãƒ¬ã‚¸è‡ªå‹•åŒæœŸãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "âŒ Airãƒ¬ã‚¸è‡ªå‹•åŒæœŸã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          fi